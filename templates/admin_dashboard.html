
{% extends "base.html" %}
{% block content %}
<h2>Admin Dashboard</h2>
<a class="btn btn-primary mb-3" href="/create-profile">Create Employee Profile</a>
<div class="list-group">
    {% for emp in employees %}
        <div class="list-group-item d-flex justify-content-between">
            <div>{{ emp.name }} ({{ emp.role }})</div>
            <a href="/edit-role/{{ emp.user_id }}" class="btn btn-sm btn-outline-primary">Edit Role</a>
        </div>
    {% endfor %}
</div>





<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Emergency Management System</h2>
        <span class="badge bg-dark">Admin Dashboard</span>
    </div>
    
    <!-- Emergency Declaration Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-danger text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Declare New Emergency</h4>
                <i class="fas fa-exclamation-triangle fa-lg"></i>
            </div>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('new_emergency') }}" class="needs-validation" novalidate>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="location" class="form-label">Emergency Location</label>
                        <input type="text" class="form-control" id="location" name="location" placeholder="123 Main St" required>
                        <div class="invalid-feedback">
                            Please provide a location.
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="emergency_type" class="form-label">Emergency Type</label>
                        <select class="form-select" id="emergency_type" name="emergency_type" required>
                            <option value="" selected disabled>Select type...</option>
                            <option value="fire">üî• Fire Outbreak</option>
                            <option value="medical">üöë Medical Emergency</option>
                            <option value="rescue">üö® Rescue Operation</option>
                            <option value="hazardous">‚ò¢Ô∏è Hazardous Material</option>
                        </select>
                        <div class="invalid-feedback">
                            Please select an emergency type.
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-danger mt-3 w-100 py-2 fw-bold">
                    <i class="fas fa-bell me-2"></i>DECLARE EMERGENCY
                </button>
            </form>
        </div>
    </div>

    <!-- Your General Alarm Card (keep this as is) -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">General Alarm</h4>
                <i class="fas fa-bell fa-lg"></i>
            </div>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('view_alarms') }}">
                <button type="submit" class="btn btn-dark w-100 py-3 fw-bold" onclick="return confirm('Are you sure you want to activate the general alarm?')">
                    <i class="fas fa-bell me-2"></i>ACTIVATE GENERAL ALARM
                </button>
            </form>
            
            <form method="POST" action="{{ url_for('activate_alarm') }}" class="mt-3">
                <button type="submit" class="btn btn-green w-100 py-3 fw-bold">
                    <i class="fas fa-bell-slash me-2"></i>ACTIVATE ALARM
                </button>
            </form>
            <form action="/deactivate_alarm" method="POST">
                <button type="submit" class="btn btn-danger mt-2">Deactivate Alarm</button>
            </form>
            
            <p class="text-muted mt-2 mb-0">This will notify all personnel to return to their stations immediately.</p>
        </div>
    </div>

    <!-- Active Emergencies Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0">Active Emergencies</h4>
        </div>
        <div class="card-body">
            {% if emergencies %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Time</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emergency in emergencies %}
                        <tr class="align-middle">
                            <td class="fw-bold">#{{ emergency.id }}</td>
                            <td>
                                <span class="badge bg-{{ 'danger' if emergency.emergency_type == 'fire' else 'warning text-dark' if emergency.emergency_type == 'hazardous' else 'info' }}">
                                    {{ emergency.emergency_type|title }}
                                </span>
                            </td>
                            <td>{{ emergency.location }}</td>
                            <td>
                                <span class="badge bg-{{ 'primary' if emergency.status == 'pending' else 'success' if emergency.status == 'resolved' else 'warning text-dark' }}">
                                    {{ emergency.status|title }}
                                </span>
                            </td>
                            <td>{{ emergency.timestamp.strftime('%H:%M') }}</td>
                            <td>
                                {% for employee in employees if emergency.assigned_employee_id == employee.id %}
                                    {{ employee.username }}
                                {% else %}
                                    <span class="text-muted">Unassigned</span>
                                {% endfor %}
                            </td>
                            <td>
                                {% if emergency.status == 'pending' %}
                                <form method="POST" action="{{ url_for('assign_emergency', emergency_id=emergency.id) }}">
                                    <select name="employee_id" class="form-select form-select-sm me-2" required>
                                        <option value="" selected disabled>Select employee...</option>
                                        {% for employee in employees %}
                                        <option value="{{ employee.id }}">{{ employee.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn btn-danger btn-sm">Assign</button>
                                </form>
                                    </div>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="alert alert-success text-center">
                                    <i class="fas fa-check-circle me-2 fa-lg"></i>
                                    <span class="h5 mb-0">No active emergencies - all clear!</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Personnel Status Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Personnel Status</h4>
        </div>
        <div class="card-body p-0">
            <ul class="list-group list-group-flush">
                {% for employee in employees %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{{ employee.username }}</h6>
                            <small class="text-muted">
                                {% for emergency in emergencies if emergency.assigned_employee_id == employee.id and emergency.status == 'dispatched' %}
                                On call: {{ emergency.emergency_type|title }} at {{ emergency.location }}
                                {% else %}
                                Available for assignment
                                {% endfor %}
                            </small>
                        </div>
                        <span class="badge bg-{{ 'success' if employee.status == 'available' else 'danger' }} rounded-pill">
                            {{ employee.status|title }}
                        </span>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>


    <!-- Resolved Emergencies Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">Resolved Emergencies</h4>
        </div>
        <div class="card-body">
            {% set resolved_emergencies = emergencies|selectattr('status', 'equalto', 'resolved')|list %}
            {% if resolved_emergencies %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Assigned To</th>
                            <th>Time Declared</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emergency in resolved_emergencies %}
                        <tr class="align-middle">
                            <td class="fw-bold">#{{ emergency.id }}</td>
                            <td>
                                <span class="badge bg-{{ 'danger' if emergency.emergency_type == 'fire' else 'warning text-dark' if emergency.emergency_type == 'hazardous' else 'info' }}">
                                    {{ emergency.emergency_type|title }}
                                </span>
                            </td>
                            <td>{{ emergency.location }}</td>
                            <td>
                                {% for employee in employees if emergency.assigned_employee_id == employee.id %}
                                    {{ employee.username }}
                                {% else %}
                                    <span class="text-muted">Unassigned</span>
                                {% endfor %}
                            </td>
                            <td>{{ emergency.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <div class="alert alert-info d-inline-flex align-items-center">
                    <i class="fas fa-info-circle me-2 fa-lg"></i>
                    <span class="h5 mb-0">No resolved emergencies yet</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
// Real-time alarm sync with localStorage
function syncAlarmStatus() {
    fetch('/check_alarm')
        .then(response => response.json())
        .then(data => {
            localStorage.setItem('alarm_status', data.active ? 'active' : 'inactive');
            
            if (data.active) {
                document.getElementById('alarm-indicator').classList.add('alarm-active');
                document.title = "üö® ALARM ACTIVE üö®";
            } else {
                document.getElementById('alarm-indicator').classList.remove('alarm-active');
                document.title = "Admin Dashboard";
            }
        });
}

// Update every 2 seconds
setInterval(syncAlarmStatus, 2000);
syncAlarmStatus(); // Initial sync

// Enhanced alarm buttons
document.addEventListener('DOMContentLoaded', function() {
    const activateBtn = document.querySelector('form[action="/trigger_alarm"] button');
    const deactivateBtn = document.querySelector('form[action="/deactivate_alarm"] button');
    
    activateBtn.addEventListener('click', function(e) {
        if (!confirm('Are you sure you want to activate the GENERAL ALARM?')) {
            e.preventDefault();
        }
    });
    
    // AJAX form submission for better UX
    document.querySelector('form[action="/deactivate_alarm"]').addEventListener('submit', function(e) {
        e.preventDefault();
        
        fetch('/deactivate_alarm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: ''  // No CSRF token anymore
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload(); // Refresh to update status
            }
        });
    });

});
</script>
<!-- Form Validation Script -->
<script>
(() => {
  'use strict'
  const forms = document.querySelectorAll('.needs-validation')
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
      }
      form.classList.add('was-validated')
    }, false)
  })
})()
</script>

<!-- Assignment Form Validation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const assignForms = document.querySelectorAll('form[action*="/assign_emergency/"]');
    assignForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const select = form.querySelector('select[name="employee_id"]');
            if (select && !select.value) {
                e.preventDefault();
                alert('Please select an employee to assign');
                select.focus();
                select.classList.add('is-invalid');
            }
        });
    });
});
</script>
{% endblock %}
